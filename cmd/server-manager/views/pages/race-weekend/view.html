{{ define "title" }}{{ $.RaceWeekend.Name }} Race Weekend{{ end }}

{{ define "content" }}

    <div class="container">

        <h1 class="text-center">{{ $.RaceWeekend.Name }}</h1>
        <p class="text-center"><em>A Race Weekend in the following car{{ if gt (len $.RaceWeekend.EntryList.CarIDs) 1 }}s{{ end }}: {{ carList ($.RaceWeekend.EntryList.CarIDs) }}</em></p>

        {{ if gt $.RaceWeekend.Progress 0.0 }}
            <div class="progress mb-5 mt-5">
                <div class="progress-bar bg-success progress-bar-striped" id="progress-bar" role="progressbar" style="width: {{ int $.RaceWeekend.Progress }}%;" aria-valuenow="{{ int $.RaceWeekend.Progress }}" aria-valuemin="0" aria-valuemax="100">{{ int $.RaceWeekend.Progress }}%</div>
            </div>
        {{ end }}

        <h2>Entrants</h2>

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <tr>
                    <th>#</th>
                    <th>Driver</th>
                    {{ if $.RaceWeekend.HasTeamNames }}
                        <th>Team</th>
                    {{ end }}
                    <th>Car</th>
                </tr>
                {{ $num := 1 }}

                {{ range $i, $entrant := $.RaceWeekend.EntryList }}
                    <tr>
                        <td>{{ $num }}</td>
                        <td>{{ driverName $entrant.Name }}</td>

                        {{ if $.RaceWeekend.HasTeamNames }}
                            <td>{{ $entrant.Team }}</td>
                        {{ end }}
                        <td>{{ prettify $entrant.Model true }} / {{ prettify $entrant.Skin false }}</td>
                    </tr>

                    {{ $num = add $num 1 }}
                {{ end }}
            </table>
        </div>


        <div class="float-right">
            {{ if WriteAccess }}
                <a class="btn btn-success" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session">Add more Sessions</a>
            {{ end }}

            <div class="dropdown show" style="display: inline-block">
                <a class="btn btn-warning dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Manage Race Weekend
                </a>

                <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    {{ if WriteAccess }}
                        <a class="dropdown-item" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/edit">
                            Edit
                        </a>
                    {{ end }}

                    <a class="dropdown-item" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/export">
                        Export
                    </a>
                </div>
            </div>
        </div>

        <div class="clearfix"></div>

        <h2>Sessions</h2>

        <p>This Race Weekend has {{ len $.RaceWeekend.Sessions }} sessions.</p>

        <hr>
    </div>

    {{ $sortedSessions := $.RaceWeekend.SortedSessions }}

    <div id="race-weekend-graph-container" class="border-secondary">

        {{ range $sessionIndex, $session := $sortedSessions }}

            {{ $raceConfig := $session.RaceConfig }}
            {{ $trackInfo := trackInfo $raceConfig.Track $raceConfig.TrackLayout }}

            <div class="race-weekend-session" id="{{ $session.ID.String }}" {{ $session.ParentsDataAttr }}>
                <div class="card border-secondary">
                    <div class="card-header">
                        {{ $acSession := $session.SessionInfo }}

                        <strong>{{ $acSession.Name }}</strong>

                        <div class="float-right">
                            {{ if ne $acSession.Time 0 }}
                                {{ $acSession.Time }} minutes
                            {{ else }}
                                {{ with $acSession.Laps }}
                                    {{ . }} laps
                                {{ end }}
                            {{ end }}

                            -

                            {{ if not ($.RaceWeekend.SessionCanBeRun $session) }}
                                <span class="text-danger" data-toggle="tooltip" title="This session cannot be run until all parent sessions have been run.">
                                    Not available
                                </span>
                            {{ else if $session.Completed }}
                                <span class="text-success">Complete</span>
                            {{ else if $session.InProgress }}
                                <span class="text-info">In Progress</span>
                            {{ else }}
                                <span class="text-warning">Ready to Start</span>
                            {{ end }}
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                {{ with $trackInfo }}
                                    {{ .Name }}{{ with .Country }}, {{ . }}{{ end }}
                                {{ else }}
                                    {{ prettify $raceConfig.Track false }} {{ with $raceConfig.TrackLayout }}({{ prettify . true }}){{ end }}
                                {{ end }}
                            </div>

                            <div class="col-4">
                                <img class="img img-fluid ml-2 float-right image-track mb-2"
                                     src="/content/tracks/{{ $raceConfig.Track }}/ui{{ with $raceConfig.TrackLayout }}/{{.}}{{ end }}/preview.png"
                                     alt="{{ $raceConfig.Track }} {{ $raceConfig.TrackLayout }}"
                                >
                            </div>
                        </div>

                        {{ if $session.Completed }}
                            <a class="btn btn-primary view-results" href="#">View Results</a>
                        {{ end }}

                        {{ if WriteAccess }}
                            {{ if not (or $session.InProgress $session.Completed) }}
                                {{ if $.RaceWeekend.SessionCanBeRun $session }}
                                    <a class="btn btn-success" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session/{{ $session.ID.String }}/start">Start Session</a>
                                {{ end }}


                                <a class="btn btn-primary" href="#">Manage Entry List</a>
                            {{ else if $session.InProgress }}
                                <a onClick="return confirm('I understand that this will restart this entire session and any current results will be lost.') "
                                   class="btn btn-warning" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session/{{ $session.ID.String }}/restart">
                                    Restart Session
                                </a>

                                <a onClick="return confirm('I understand that this will cancel this entire session and any current results will be lost.') "
                                   class="btn btn-danger" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session/{{ $session.ID.String }}/cancel">
                                    Cancel Session
                                </a>
                            {{ end }}

                            <div class="dropdown show d-inline-block">
                                <a class="btn btn-warning dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Manage Session
                                </a>

                                <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                    <a class="dropdown-item" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session/{{ $session.ID.String }}/edit">
                                        Edit
                                    </a>

                                    <a class="dropdown-item" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session/{{ $session.ID.String }}/import">
                                        Import Results
                                    </a>

                                    {{ if DeleteAccess }}
                                        <a onClick="return confirm('I understand that this will delete this entire session permanently.') "
                                           class="dropdown-item text-danger" href="/race-weekend/{{ $.RaceWeekend.ID.String }}/session/{{ $session.ID.String }}/delete">
                                            Delete
                                        </a>
                                    {{ end }}
                                </div>
                            </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        {{ end }}
    </div>

    <div class="container" id="race-weekend-results">
        <h2>Results</h2>

        <div class="accordion" id="sessionResults">
            {{ range $sessionIndex, $session := $sortedSessions }}
                <div class="card">
                    <div class="card-header" id="results-link-{{ $session.ID.String }}" data-toggle="collapse" data-target="#results-{{ $session.ID.String }}" aria-expanded="true" aria-controls="results-{{ $session.ID.String }}">
                        {{ $acSession := $session.SessionInfo }}
                        {{ $trackInfo := trackInfo $session.RaceConfig.Track $session.RaceConfig.TrackLayout }}

                        <strong>
                            {{ $acSession.Name }}
                        </strong>

                        at

                        {{ with $trackInfo }}
                            {{ .Name }}
                        {{ else }}
                            {{ prettify $session.RaceConfig.Track false }} {{ with $session.RaceConfig.TrackLayout }}({{ prettify . true }}){{ end }}
                        {{ end }}

                        <div class="float-right">
                            {{ if ne $acSession.Time 0 }}
                                {{ $acSession.Time }} minutes
                            {{ else }}
                                {{ with $acSession.Laps }}
                                    {{ . }} laps
                                {{ end }}
                            {{ end }}

                            -

                            {{ if not ($.RaceWeekend.SessionCanBeRun $session) }}
                                <span class="text-danger" data-toggle="tooltip" title="This session cannot be run until all parent sessions have been run.">
                                        Not available
                                    </span>
                            {{ else if $session.Completed }}
                                <span class="text-success">Complete</span>
                            {{ else if $session.InProgress }}
                                <span class="text-info">In Progress</span>
                            {{ else }}
                                <span class="text-warning">Ready to Start</span>
                            {{ end }}
                        </div>
                    </div>

                    <div id="results-{{ $session.ID.String }}" class="collapse {{ if eq $sessionIndex 0 }}show{{ end }}" aria-labelledby="results-link-{{ $session.ID.String }}" data-parent="#sessionResults">
                        <div class="card-body pt-0 pb-0 pl-2 pr-2">
                            {{ if $session.Completed }}

                                <p class="text-center mt-2 mb-2">
                                    <a class="detailed-results" href="/results/{{ $session.Results.SessionFile }}">View detailed results breakdown for this Session</a>
                                </p>

                                {{ template "session-overall" dict "sessionResults" $session.Results "account" $.Account }}
                            {{ else if $session.InProgress }}
                                <p class="text-center mt-4 pb-2"><strong>Session in Progress</strong>: Looks like there aren't any results yet. Check back later.</p>
                            {{ else }}
                                <p class="text-center mt-4 pb-2"><strong>Awaiting Start</strong>: Looks like this session hasn't started yet. Check back later.</p>
                            {{ end }}
                        </div>
                    </div>
                </div>
            {{ end }}
        </div>
    </div>


    <div class="modal" tabindex="-1" role="dialog" id="filters-modal">
        <!-- content controlled by js -->
    </div>


    <script type="text/javascript">
        var RaceWeekendID = {{ $.RaceWeekend.ID.String }};
    </script>
{{ end }}